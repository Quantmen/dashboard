<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard Content</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }
        
        /* Loading state styles */
        .loading-state {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
        }
        
        .loading-state.active {
            display: block;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #1e40af;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .loading-message {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .main-content {
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px;
            background: #f8fafc;
            height: 100vh;
            width: 100%;
        }
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 20px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
        .page-subtitle { font-size: 13px; color: #64748b; }
        .top-section { display: grid; grid-template-columns: 340px 1fr; gap: 20px; margin-bottom: 20px; }
        .second-row { display: grid; grid-template-columns: 260px 240px 1fr; gap: 20px; margin-bottom: 20px; }
        .middle-column { display: grid; grid-template-rows: 1fr 1fr; gap: 10px; }
        .card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s ease;
        }
        .card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05); }
        .card-title {
            font-size: 13px;
            color: #64748b;
            text-transform: capitalize;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .card-value { font-size: 28px; font-weight: 700; margin-bottom: 6px; line-height: 1.1; }
        .card-subtitle { font-size: 13px; color: #94a3b8; }
        .pnl-card { display: flex; flex-direction: column; justify-content: center; min-height: 120px; }
        .pnl-card .card-value { font-size: 34px; font-weight: 700; letter-spacing: -1px; }
        .trades-card .card-value { color: #1e40af; font-size: 30px; }
        .strategy-pnl-list {
            margin-top: 12px;
            font-size: 12px;
            border-top: 1px solid #f1f5f9;
            padding-top: 12px;
        }
        .strategy-pnl-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            color: #475569;
        }
        .strategy-pnl-item .strategy-name { font-weight: 500; }
        .strategy-pnl-item .pnl-value { font-weight: 600; text-align: right; }
        .profit-loss-card { text-align: left; display: flex; flex-direction: column; justify-content: center; }
        .profit-loss-card .card-value { font-size: 28px; }
        .positive { color: #059669; }
        .negative { color: #dc2626; }
        .earnings-card { display: flex; flex-direction: column; justify-content: center; }
        .earnings-card .card-value { font-size: 28px; }
        .chart-card { padding: 16px 18px; }
        .chart-card .card-title { font-size: 13px; margin-bottom: 12px; }
        .chart-container { height: 240px; position: relative; width: 100%; }
        .chart-container canvas { width: 100% !important; height: 100% !important; }
        .strategy-performance-container { min-height: 120px; }
        .strategy-performance-header {
            font-size: 14px;
            color: #475569;
            margin-bottom: 16px;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.5px;
        }
        .strategy-grid-inline {
            display: flex;
            flex-wrap: nowrap;
            gap: 14px;
            min-width: 0;
        }
        .strategy-card-inline {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid #f1f5f9;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s ease;
            min-width: 0;
            overflow: hidden;
            flex: 1 1 0;
        }
        .strategy-card-inline:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        .strategy-label {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            word-break: break-word;
        }
        .strategy-pnl { font-size: 20px; font-weight: 700; line-height: 1; word-break: break-word; }
        .strategy-stats { font-size: 12px; color: #64748b; margin-top: 4px; word-break: break-word; }
        .win-rate-bar {
            width: 100%;
            height: 5px;
            background: #f1f5f9;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        .win-rate-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 3px;
        }
        .win-rate-fill.profit { background: linear-gradient(90deg, #059669 0%, #10b981 100%); }
        .win-rate-fill.loss { background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%); }
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .bottom-card {
            background: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid #f1f5f9;
            min-height: 280px;
            max-height: 450px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .bottom-card-header {
            font-size: 13px;
            color: #475569;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.5px;
            background: white;
            padding: 14px 20px 10px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        .bottom-card-content { overflow-y: auto; flex: 1; padding: 0 20px 20px 20px; }
        .strategy-tabs {
            display: flex;
            gap: 6px;
            padding-top: 4px;
            margin-bottom: 0;
            flex-wrap: wrap;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 4px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 11;
        }
        .strategy-tab {
            padding: 6px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s ease;
        }
        .strategy-tab:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            color: #475569;
        }
        .strategy-tab.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }
        .orders-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .orders-table th {
            background: #f8fafc;
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 38px;
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            z-index: 10;
        }
        .orders-table td {
            padding: 12px 6px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }
        .orders-table tr:hover { background: #f8fafc; }
        .orders-table .profit-cell { font-weight: 600; text-align: right; }
        .orders-table .profit-cell.positive { color: #059669; }
        .orders-table .profit-cell.negative { color: #dc2626; }
        .no-data { text-align: center; color: #cbd5e1; padding: 30px; font-size: 13px; }
        canvas { width: 100% !important; height: 100% !important; }
        @media (max-width: 1400px) {
            .bottom-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 1024px) {
            /* Top section - stack Today P&L and Strategy Performance vertically */
            .top-section { 
                display: grid !important;
                grid-template-columns: 1fr !important;
                grid-template-rows: auto auto !important;
                gap: 16px !important;
                margin-bottom: 16px !important;
            }
            
            /* Same layout as mobile: 3 cards in one row */
            .second-row { 
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                grid-template-rows: auto auto !important;
                gap: 16px !important;
                margin-bottom: 20px !important;
            }
            
            .second-row .trades-card { 
                grid-column: 1 !important;
                grid-row: 1 !important;
            }
            
            .second-row .middle-column { 
                grid-column: 2 / 4 !important;
                grid-row: 1 !important;
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                grid-template-rows: auto !important;
                gap: 16px !important;
            }
            
            .second-row .chart-card {
                grid-column: 1 / -1 !important;
                grid-row: 2 !important;
            }
        }
        @media (max-width: 768px) {
            .main-content { padding: 12px; }
            
            /* Top section already stacked from 1024px breakpoint */
            .top-section { 
                gap: 12px !important;
                margin-bottom: 12px !important;
            }
            
            .bottom-grid { grid-template-columns: 1fr; }
            
            /* Adjust spacing for mobile */
            .second-row { 
                gap: 12px !important;
                margin-bottom: 12px !important;
            }
            
            .second-row .middle-column { 
                gap: 12px !important;
            }
            
            /* Reduce card padding and font sizes for mobile */
            .card { padding: 12px; }
            .card-title { font-size: 11px; margin-bottom: 8px; }
            .card-value { font-size: 20px; margin-bottom: 4px; }
            .trades-card .card-value { font-size: 22px; }
            .profit-loss-card .card-value { font-size: 20px; }
            .earnings-card .card-value { font-size: 20px; }
            
            .strategy-grid-inline { gap: 10px; }
            .strategy-card-inline { padding: 12px; }
            .strategy-label { font-size: 11px; }
            .strategy-pnl { font-size: 18px; }
            .strategy-stats { font-size: 11px; }
            .chart-container { height: 200px; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- Loading state indicator (hidden by default) -->
    <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <div class="loading-message">Loading dashboard data...</div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="top-section">
            <div>
                <div class="strategy-performance-header">Today P&L</div>
                <div class="card pnl-card" style="flex-direction: row; align-items: center; justify-content: space-between;">
                    <div>
                        <div class="card-value positive" id="todayPnl">₹0</div>
                        <div class="card-subtitle">Gross profit/loss</div>
                    </div>
                    <div id="todayBrokerProfits" style="font-size: 13px; color: #64748b; display: flex; flex-direction: column; gap: 3px; text-align: right;"></div>
                </div>
            </div>
            
            <div class="strategy-performance-container">
                <div class="strategy-performance-header">Strategy Performance</div>
                <div class="strategy-grid-inline" id="strategyGridInline">
                    <div class="no-data">Upload Excel file to view strategies</div>
                </div>
            </div>
        </div>

        <div class="second-row">
            <div class="card trades-card">
                <div class="card-title">Total Trades</div>
                <div class="card-value" id="totalTrades">0</div>
                <div class="strategy-pnl-list" id="strategyPnlList"></div>
            </div>

            <div class="middle-column">
                <div class="card profit-loss-card">
                    <div class="card-title">Profit & Loss</div>
                    <div class="card-value positive" id="profitLoss">₹0.00</div>
                    <div id="brokerPnlList" style="margin-top: 12px; font-size: 13px; color: #64748b; display: flex; flex-direction: column; gap: 4px;"></div>
                </div>

                <div class="card earnings-card">
                    <div class="card-title">Margin</div>
                    <div class="card-value" id="totalMargin">₹0</div>
                    <div style="font-size: 11px; color: #94a3b8; margin-top: 1px;">Margin include today approx PNL</div>
                    <div id="brokerMarginList" style="margin-top: 10px; font-size: 13px; color: #64748b; display: flex; flex-direction: column; gap: 2px;"></div>
                </div>           
            </div>

            <div class="card chart-card">
                <div class="card-title">Cumulative P&L Chart</div>
                <div class="chart-container">
                    <canvas id="pnlChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bottom-grid">
            <div class="bottom-card">
                <h3 class="bottom-card-header">Brokers Order</h3>
                <div class="bottom-card-content" id="ordersSummary">
                    <div class="no-data">No Data</div>
                </div>
            </div>

            <div class="bottom-card">
                <h3 class="bottom-card-header">Strategy Order</h3>
                <div class="bottom-card-content" id="recentOrders">
                    <div class="no-data">No Data</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cache DOM elements
        const elements = {
            loadingState: document.getElementById('loadingState'),
            mainContent: document.getElementById('mainContent'),
            todayPnl: document.getElementById('todayPnl'),
            todayBrokerProfits: document.getElementById('todayBrokerProfits'),
            strategyGridInline: document.getElementById('strategyGridInline'),
            totalTrades: document.getElementById('totalTrades'),
            strategyPnlList: document.getElementById('strategyPnlList'),
            profitLoss: document.getElementById('profitLoss'),
            brokerPnlList: document.getElementById('brokerPnlList'),
            totalMargin: document.getElementById('totalMargin'),
            brokerMarginList: document.getElementById('brokerMarginList'),
            ordersSummary: document.getElementById('ordersSummary'),
            recentOrders: document.getElementById('recentOrders'),
            pnlChart: document.getElementById('pnlChart')
        };

        let allTrades = [];
        let chartInstance = null;
        let selectedStrategy = null;
        let selectedRecentStrategy = null;
        let brokerCodeMap = {};
        
        // Show content immediately on load (no waiting)
        function showContent() {
            elements.loadingState.classList.remove('active');
            elements.mainContent.style.opacity = '1';
            console.log('✅ Dashboard content shown');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            console.log('📊 Dashboard loaded');
            initializeChart();
            updateStrategyCards({});
            // Show content immediately - no loading state on page load
            showContent();
        });

        window.addEventListener('message', (event) => {
            const { type, data } = event.data;
            if (type === 'TRADES_DATA') {
                console.log(`🔥 Received ${data?.length || 0} trades`);
                
                // Show loading when processing data
                elements.loadingState.classList.add('active');
                elements.mainContent.style.opacity = '0.3';
                
                // Validate data before processing
                if (!data || !Array.isArray(data) || data.length === 0) {
                    console.warn('⚠️ Received empty or invalid data');
                    showContent();
                    return;
                }
                
                allTrades = data;
                
                // Process data and then show content
                setTimeout(() => {
                    updateDashboard();
                    showContent();
                }, 100);
                
            } else if (type === 'LOAD_SAMPLE_DATA') {
                console.log('🎲 Loading sample data');
                loadSampleData();
            }
        });

        function formatStrategyName(strategyName) {
            if (!strategyName) return strategyName;
            
            let cleanName = strategyName.startsWith('PNL_') ? strategyName.substring(4) : strategyName;
            const brokerCode = brokerCodeMap[strategyName] || brokerCodeMap[cleanName];
            
            if (brokerCode) {
                const proMatch = cleanName.match(/(PRO\s*\d+)$/);
                if (proMatch) return `${brokerCode} ${proMatch[1]}`;
            }
            
            return cleanName.replace(/_/g, ' ').replace(/B(\d)/g, 'BR$1').replace(/(\d)(PRO)/g, '$1 $2');
        }

        function loadSampleData() {
            // Show loading
            elements.loadingState.classList.add('active');
            elements.mainContent.style.opacity = '0.3';
            
            allTrades = [];
            const strategies = ['PRO 1', 'PRO 2', 'PRO 3', 'PRO 4', 'PRO 5'];
            const symbols = ['NIFTY', 'BANKNIFTY', 'FINNIFTY', 'SENSEX'];
            const brokerCodes = ['AC', 'CE'];
            let cumPnl = 0;
            
            for (let i = 0; i < 150; i++) {
                const strategy = strategies[Math.floor(Math.random() * strategies.length)];
                const profit = (Math.random() - 0.45) * 5000;
                cumPnl += profit;
                
                const strategyDetails = {};
                const pnlStrategies = {};
                const pnlTaxStrategies = {};
                const brokerCodesMap = {};
                
                for (let idx = 0; idx < strategies.length; idx++) {
                    const strat = strategies[idx];
                    const stratName = idx < 2 ? `B1${strat.replace(' ', '')}` : `B2${strat.replace(' ', '')}`;
                    const isActive = strat === strategy;
                    
                    pnlStrategies[stratName] = isActive ? profit : 0;
                    pnlTaxStrategies[stratName] = isActive ? profit * 0.95 : 0;
                    brokerCodesMap[stratName] = brokerCodes[idx % brokerCodes.length];
                    
                    strategyDetails[stratName] = {
                        buy: isActive ? 18000 + Math.random() * 2000 : 0,
                        qty: isActive ? Math.floor(Math.random() * 100) + 25 : 0,
                        sell: isActive ? 18000 + Math.random() * 2000 : 0,
                        unpnl: isActive ? (Math.random() - 0.5) * 1000 : 0,
                        margin: idx < 2 ? Math.floor(Math.random() * 5000000) + 40000000 : Math.floor(Math.random() * 2000000) + 18000000,
                        lot: isActive ? Math.floor(Math.random() * 50) + 25 : 0,
                        pnl: isActive ? profit : 0,
                        dpnl: isActive ? profit * 0.95 : 0
                    };
                }
                
                allTrades.push({
                    sno: i + 1,
                    date: '05/10/2025',
                    strategy: strategy,
                    trade: Math.random() > 0.5 ? 'LONG' : 'SHORT',
                    symbol: symbols[Math.floor(Math.random() * symbols.length)],
                    qty: Math.floor(Math.random() * 100) + 25,
                    profit: profit,
                    cumPnl: cumPnl,
                    entry: 18000 + Math.random() * 2000,
                    exit: 18000 + Math.random() * 2000,
                    strategyPnls: pnlStrategies,
                    strategyPnlTax: pnlTaxStrategies,
                    strategyDetails: strategyDetails,
                    brokerCodes: brokerCodesMap
                });
            }
            
            console.log('✅ Sample data generated');
            updateDashboard();
            showContent();
            window.parent.postMessage({ type: 'TRADES_DATA', data: allTrades }, '*');
        }

        function updateDashboard() {
            console.log('🔄 Updating dashboard...');
            
            try {
                const todayTrades = getTodayTrades();
                updateBrokerCodeMap(todayTrades);
                const strategies = calculateStrategies(todayTrades);
                
                updateTodayPnl(todayTrades, strategies);
                updateTotalTrades();
                updateProfitLoss(todayTrades);
                updateMargin(todayTrades);
                updateStrategyCards(strategies);
                updateOrdersSummary(todayTrades);
                updateRecentOrders(todayTrades);
                updateChart();
                
                console.log('✅ Dashboard updated successfully');
            } catch (error) {
                console.error('❌ Error updating dashboard:', error);
            }
        }

        function getTodayTrades() {
            if (allTrades.length === 0) return [];
            
            const latestDate = allTrades[allTrades.length - 1].date;
            const todayTrades = [];
            
            for (let i = allTrades.length - 1; i >= 0; i--) {
                if (allTrades[i].date === latestDate) {
                    todayTrades.push(allTrades[i]);
                } else {
                    break;
                }
            }
            
            return todayTrades;
        }

        function getYesterdayTrades() {
            if (allTrades.length === 0) return [];
            
            const latestDate = allTrades[allTrades.length - 1].date;
            const yesterdayTrades = [];
            let foundYesterday = false;
            let yesterdayDate = null;
            
            for (let i = allTrades.length - 1; i >= 0; i--) {
                if (allTrades[i].date === latestDate) {
                    continue; // Skip today's trades
                } else if (!foundYesterday) {
                    foundYesterday = true;
                    yesterdayDate = allTrades[i].date;
                    yesterdayTrades.push(allTrades[i]);
                } else if (allTrades[i].date === yesterdayDate) {
                    yesterdayTrades.push(allTrades[i]);
                } else {
                    break;
                }
            }
            
            return yesterdayTrades;
        }


        function updateBrokerCodeMap(todayTrades) {
            const len = todayTrades.length;
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.brokerCodes) {
                    const codes = Object.entries(trade.brokerCodes);
                    for (let j = 0; j < codes.length; j++) {
                        const [strategyName, brokerCode] = codes[j];
                        if (brokerCode && !brokerCodeMap[strategyName]) {
                            brokerCodeMap[strategyName] = brokerCode;
                            brokerCodeMap['PNL_' + strategyName] = brokerCode;
                        }
                    }
                }
            }
        }

        function updateTodayPnl(todayTrades, strategies) {
            const todayPnl = Object.values(strategies).reduce((sum, s) => sum + s.totalPnl, 0);
            elements.todayPnl.textContent = `₹${todayPnl >= 0 ? '' : '-'}${Math.abs(todayPnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
            elements.todayPnl.className = `card-value ${todayPnl >= 0 ? 'positive' : 'negative'}`;

            const brokerProfits = {};
            const len = todayTrades.length;
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.brokerCodes) {
                    const entries = Object.entries(trade.strategyPnls);
                    for (let j = 0; j < entries.length; j++) {
                        const [strategyName, pnl] = entries[j];
                        if (!strategyName.startsWith('A.PRO')) {
                            const brokerCode = trade.brokerCodes[strategyName];
                            if (brokerCode) {
                                brokerProfits[brokerCode] = (brokerProfits[brokerCode] || 0) + (pnl || 0);
                            }
                        }
                    }
                }
            }

            const htmlParts = [];
            const brokerKeys = Object.keys(brokerProfits).sort();
            for (let i = 0; i < brokerKeys.length; i++) {
                const brokerCode = brokerKeys[i];
                const profit = brokerProfits[brokerCode];
                const colorClass = profit >= 0 ? 'positive' : 'negative';
                htmlParts.push(`<div style="display: flex; gap: 8px;">
                    <span>${brokerCode} profit:</span>
                    <span class="${colorClass}" style="font-weight: 600;">₹${profit >= 0 ? '' : '-'}${Math.abs(profit).toLocaleString('en-IN', {maximumFractionDigits: 0})}</span>
                </div>`);
            }

            elements.todayBrokerProfits.innerHTML = htmlParts.join('');
        }

        function updateTotalTrades() {
            elements.totalTrades.textContent = allTrades.length.toLocaleString();
            
            const totalStrategyPnls = {};
            const len = allTrades.length;
            
            for (let i = 0; i < len; i++) {
                const trade = allTrades[i];
                const entries = Object.entries(trade.strategyPnlTax);
                for (let j = 0; j < entries.length; j++) {
                    const [strategyName, pnl] = entries[j];
                    totalStrategyPnls[strategyName] = (totalStrategyPnls[strategyName] || 0) + (pnl || 0);
                }
            }
            
            const htmlParts = [];
            const entries = Object.entries(totalStrategyPnls)
                .filter(([name, pnl]) => pnl !== 0 && !name.startsWith('A.PRO'))
                .sort((a, b) => a[0].localeCompare(b[0]));
            
            for (let i = 0; i < entries.length; i++) {
                const [name, pnl] = entries[i];
                const colorClass = pnl >= 0 ? 'positive' : 'negative';
                const displayName = name.replace(/_/g, ' ').replace(/(\d)(PRO)/g, '$1 $2');
                htmlParts.push(`<div class="strategy-pnl-item">
                    <span class="strategy-name">${displayName}</span>
                    <span class="pnl-value ${colorClass}">₹${pnl >= 0 ? '' : '-'}${Math.abs(pnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}</span>
                </div>`);
            }
            
            elements.strategyPnlList.innerHTML = htmlParts.join('');
        }

        function updateProfitLoss(todayTrades) {
            const allBrokerStrategyPnls = {};
            const len = allTrades.length;
            
            for (let i = 0; i < len; i++) {
                const trade = allTrades[i];
                if (trade.brokerCodes) {
                    const entries = Object.entries(trade.brokerCodes);
                    for (let j = 0; j < entries.length; j++) {
                        const [strategyName, brokerCode] = entries[j];
                        if (!strategyName.startsWith('A.PRO') && brokerCode) {
                            const key = `${brokerCode}_${strategyName}`;
                            if (!allBrokerStrategyPnls[key]) {
                                allBrokerStrategyPnls[key] = { broker: brokerCode, pnl: 0 };
                            }
                            allBrokerStrategyPnls[key].pnl += trade.strategyPnlTax[strategyName] || 0;
                        }
                    }
                }
            }
            
            const totalPnl = Object.values(allBrokerStrategyPnls).reduce((sum, data) => sum + data.pnl, 0);
            elements.profitLoss.textContent = `₹${Math.abs(totalPnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
            elements.profitLoss.className = `card-value ${totalPnl >= 0 ? 'positive' : 'negative'}`;
            
            const brokerTotals = {};
            const values = Object.values(allBrokerStrategyPnls);
            for (let i = 0; i < values.length; i++) {
                const data = values[i];
                brokerTotals[data.broker] = (brokerTotals[data.broker] || 0) + data.pnl;
            }

            const todayBrokerCodes = new Set();
            const todayLen = todayTrades.length;
            for (let i = 0; i < todayLen; i++) {
                const trade = todayTrades[i];
                if (trade.brokerCodes) {
                    const codes = Object.values(trade.brokerCodes);
                    for (let j = 0; j < codes.length; j++) {
                        const code = codes[j];
                        if (code && code !== 'A' && !code.startsWith('A.')) {
                            todayBrokerCodes.add(code);
                        }
                    }
                }
            }

            const htmlParts = [];
            const brokerArray = Array.from(todayBrokerCodes).sort();
            for (let i = 0; i < brokerArray.length; i++) {
                const brokerCode = brokerArray[i];
                const total = brokerTotals[brokerCode] || 0;
                const colorClass = total >= 0 ? 'positive' : 'negative';
                htmlParts.push(`<div style="display: flex; justify-content: space-between;">
                    <span>${brokerCode} Total:</span>
                    <span class="${colorClass}" style="font-weight: 600;">₹${total >= 0 ? '' : '-'}${Math.abs(total).toLocaleString('en-IN', {maximumFractionDigits: 0})}</span>
                </div>`);
            }

            elements.brokerPnlList.innerHTML = htmlParts.join('');
        }

        function updateMargin(todayTrades) {
            const brokerMargins = {};
            const len = todayTrades.length;
            
            // Only use today's margin data
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.brokerCodes && trade.strategyDetails) {
                    const entries = Object.entries(trade.strategyDetails);
                    for (let j = 0; j < entries.length; j++) {
                        const [strategyName, details] = entries[j];
                        if (!strategyName.startsWith('A.PRO')) {
                            const margin = details.margin || 0;
                            const brokerCode = trade.brokerCodes[strategyName];
                            if (brokerCode && margin > 0) {
                                brokerMargins[brokerCode] = Math.max(brokerMargins[brokerCode] || 0, margin);
                            }
                        }
                    }
                }
            }
            
            const totalMargin = Object.values(brokerMargins).reduce((sum, m) => sum + m, 0);
            
            // Calculate today's PNL TAX
            let todayNetPnl = 0;
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.strategyPnlTax) {
                    const entries = Object.entries(trade.strategyPnlTax);
                    for (let j = 0; j < entries.length; j++) {
                        const [stratName, pnl] = entries[j];
                        if (!stratName.startsWith('A.PRO')) {
                            todayNetPnl += pnl || 0;
                        }
                    }
                }
            }
            
            const totalMarginWithPnl = totalMargin + todayNetPnl;
            elements.totalMargin.textContent = `₹${Math.abs(totalMarginWithPnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
            elements.totalMargin.className = 'card-value';
            elements.totalMargin.style.color = '#1e40af';

            // Get all broker codes from today's trades
            const allBrokerCodes = new Set();
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.brokerCodes) {
                    const entries = Object.entries(trade.brokerCodes);
                    for (let j = 0; j < entries.length; j++) {
                        const [strategyName, code] = entries[j];
                        if (code && !strategyName.startsWith('A.PRO')) {
                            allBrokerCodes.add(code);
                        }
                    }
                }
            }

            const htmlParts = [];
            const brokerArray = Array.from(allBrokerCodes).sort();
            for (let i = 0; i < brokerArray.length; i++) {
                const brokerCode = brokerArray[i];
                const margin = brokerMargins[brokerCode] || 0;
                htmlParts.push(`<div style="display: flex; justify-content: space-between;">
                    <span>${brokerCode} Margin:</span>
                    <span style="font-weight: 600; color: #1e40af;">₹${Math.abs(margin).toLocaleString('en-IN', {maximumFractionDigits: 0})}</span>
                </div>`);
            }

            elements.brokerMarginList.innerHTML = htmlParts.join('');
        }

        function calculateStrategies(todayTrades) {
            const strategies = {};
            
            if (todayTrades.length > 0) {
                const todayDate = todayTrades[0].date;
                const todayPnls = {};
                
                const len = todayTrades.length;
                for (let i = 0; i < len; i++) {
                    const trade = todayTrades[i];
                    if (trade.date === todayDate) {
                        const entries = Object.entries(trade.strategyPnls);
                        for (let j = 0; j < entries.length; j++) {
                            const [strategyName, pnl] = entries[j];
                            const pnlValue = parseFloat(pnl) || 0;
                            if (pnlValue !== 0) {
                                todayPnls[strategyName] = (todayPnls[strategyName] || 0) + pnlValue;
                            }
                        }
                    }
                }
                
                const pnlEntries = Object.entries(todayPnls);
                for (let i = 0; i < pnlEntries.length; i++) {
                    const [strategyName, pnl] = pnlEntries[i];
                    if (!strategyName.startsWith('A.PRO')) {
                        strategies[strategyName] = { totalPnl: pnl, trades: 0, wins: 0, losses: 0 };
                    }
                }
                
                const strategyKeys = Object.keys(strategies);
                for (let i = 0; i < len; i++) {
                    const trade = todayTrades[i];
                    if (trade.date === todayDate) {
                        for (let j = 0; j < strategyKeys.length; j++) {
                            const strategyKey = strategyKeys[j];
                            const pnl = trade.strategyPnls[strategyKey];
                            if (pnl !== undefined && pnl !== null && pnl !== 0) {
                                strategies[strategyKey].trades++;
                                if (pnl > 0) strategies[strategyKey].wins++;
                                else if (pnl < 0) strategies[strategyKey].losses++;
                            }
                        }
                    }
                }
            }
            
            return strategies;
        }

        function updateStrategyCards(strategies) {
            const strategyEntries = Object.entries(strategies).sort((a, b) => a[0].localeCompare(b[0]));
            
            const htmlParts = [];
            
            if (strategyEntries.length > 0) {
                for (let i = 0; i < strategyEntries.length; i++) {
                    const [name, data] = strategyEntries[i];
                    const winRate = data.trades > 0 ? (data.wins / data.trades * 100) : 0;
                    htmlParts.push(`<div class="strategy-card-inline">
                        <div class="strategy-label">${formatStrategyName(name)}</div>
                        <div class="strategy-pnl ${data.totalPnl >= 0 ? 'positive' : 'negative'}">
                            ₹${data.totalPnl >= 0 ? '' : '-'}${Math.abs(data.totalPnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}
                        </div>
                        <div class="strategy-stats">Trades: ${data.trades.toLocaleString()} | Win: ${winRate.toFixed(1)}% | W/L: ${data.wins}/${data.losses}</div>
                        <div class="win-rate-bar">
                            <div class="win-rate-fill ${winRate >= 50 ? 'profit' : 'loss'}" style="width: ${winRate}%"></div>
                        </div>
                    </div>`);
                }
                
                const minCards = 4;
                for (let i = strategyEntries.length; i < minCards; i++) {
                    htmlParts.push(`<div class="strategy-card-inline" style="opacity: 0.5;">
                        <div class="strategy-label">NO STRATEGY</div>
                        <div class="strategy-pnl" style="color: #94a3b8;">₹0</div>
                        <div class="strategy-stats">Trades: 0 | Win: 0.0% | W/L: 0/0</div>
                        <div class="win-rate-bar"><div class="win-rate-fill" style="width: 0%; background: #e2e8f0;"></div></div>
                    </div>`);
                }
            } else {
                for (let i = 0; i < 4; i++) {
                    htmlParts.push(`<div class="strategy-card-inline" style="border: 2px dashed #d1d5db; background: #fafbfc; box-shadow: none;">
                        <div class="strategy-label" style="color: #9ca3af;">STRATEGY ${i + 1}</div>
                        <div class="strategy-pnl" style="color: #9ca3af;">₹0</div>
                        <div class="strategy-stats" style="color: #9ca3af;">Trades: 0 | Win: 0.0% | W/L: 0/0</div>
                        <div class="win-rate-bar"><div class="win-rate-fill" style="width: 0%; background: #e2e8f0;"></div></div>
                    </div>`);
                }
            }
            
            elements.strategyGridInline.innerHTML = htmlParts.join('');
        }

        function updateOrdersSummary(todayTrades) {
            if (todayTrades.length === 0) {
                elements.ordersSummary.innerHTML = '<div class="no-data">No Data</div>';
                return;
            }
            
            const strategies = new Set();
            const len = todayTrades.length;
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                const keys = Object.keys(trade.strategyDetails);
                for (let j = 0; j < keys.length; j++) {
                    const strategy = keys[j];
                    const details = trade.strategyDetails[strategy];
                    if (details.buy !== 0 || details.sell !== 0 || details.qty !== 0) {
                        strategies.add(strategy);
                    }
                }
            }
            
            const strategyArray = Array.from(strategies).sort((a, b) => {
                const proMatchA = a.match(/PRO\s*(\d+)/i);
                const proMatchB = b.match(/PRO\s*(\d+)/i);
                
                if (proMatchA && proMatchB) {
                    const proNumA = parseInt(proMatchA[1]);
                    const proNumB = parseInt(proMatchB[1]);
                    if (proNumA !== proNumB) return proNumA - proNumB;
                    return (brokerCodeMap[a] || '').localeCompare(brokerCodeMap[b] || '');
                }
                return a.localeCompare(b);
            });
            
            if (strategyArray.length === 0) {
                elements.ordersSummary.innerHTML = '<div class="no-data">No Data</div>';
                return;
            }
            
            if (!selectedStrategy || !strategyArray.includes(selectedStrategy)) {
                selectedStrategy = strategyArray[0];
            }
            
            const htmlParts = ['<div class="strategy-tabs">'];
            for (let i = 0; i < strategyArray.length; i++) {
                const strategy = strategyArray[i];
                htmlParts.push(`<div class="strategy-tab ${strategy === selectedStrategy ? 'active' : ''}" onclick="selectStrategy('${strategy}')">${formatStrategyName(strategy)}</div>`);
            }
            htmlParts.push('</div>');
            
            htmlParts.push('<table class="orders-table"><thead><tr>');
            htmlParts.push('<th>S.No</th><th>Date</th><th>Symbol</th><th>Qty</th>');
            htmlParts.push('<th style="text-align: right;">Buy Price</th><th style="text-align: right;">Sell Price</th>');
            htmlParts.push('<th style="text-align: right;">PNL</th><th style="text-align: right;">Un PNL</th>');
            htmlParts.push('<th style="text-align: right;">Lot Size</th><th style="text-align: right;">Lot PNL</th><th style="text-align: right;">Slippage</th>');
            htmlParts.push('</tr></thead><tbody>');
            
            const filteredTrades = todayTrades
                .filter(trade => {
                    const details = trade.strategyDetails[selectedStrategy];
                    return details && (details.buy !== 0 || details.sell !== 0 || details.qty !== 0);
                })
                .sort((a, b) => (a.symbol || '').toString().toUpperCase().localeCompare((b.symbol || '').toString().toUpperCase()));
            
            for (let i = 0; i < filteredTrades.length; i++) {
                const trade = filteredTrades[i];
                const details = trade.strategyDetails[selectedStrategy];
                const pnl = trade.strategyPnls[selectedStrategy] || 0;
                const lotPnl = details.lot > 0 ? pnl / details.lot : 0;
                
                htmlParts.push(`<tr>
                    <td>${trade.sno}</td>
                    <td>${trade.date}</td>
                    <td>${trade.symbol}</td>
                    <td>${details.qty > 0 ? details.qty : '-'}</td>
                    <td style="text-align: right;">${details.buy > 0 ? details.buy.toFixed(2) : '-'}</td>
                    <td style="text-align: right;">${details.sell > 0 ? details.sell.toFixed(2) : '-'}</td>
                    <td class="profit-cell ${pnl >= 0 ? 'positive' : 'negative'}">${pnl !== 0 ? `₹${pnl >= 0 ? '' : '-'}${Math.abs(pnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '-'}</td>
                    <td class="profit-cell ${details.unpnl >= 0 ? 'positive' : 'negative'}">${details.unpnl !== 0 ? `${details.unpnl >= 0 ? '' : '-'}${Math.abs(details.unpnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '-'}</td>
                    <td style="text-align: right;">${details.lot > 0 ? details.lot : '-'}</td>
                    <td class="profit-cell ${lotPnl >= 0 ? 'positive' : 'negative'}">${details.lot > 0 && pnl !== 0 ? `₹${lotPnl >= 0 ? '' : '-'}${Math.abs(lotPnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '-'}</td>
                    <td class="profit-cell ${details.dpnl >= 0 ? 'positive' : 'negative'}">${details.dpnl !== 0 ? `₹${details.dpnl >= 0 ? '' : '-'}${Math.abs(details.dpnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '-'}</td>
                </tr>`);
            }
            
            htmlParts.push('</tbody></table>');
            elements.ordersSummary.innerHTML = htmlParts.join('');
        }
        
        function selectStrategy(strategy) {
            selectedStrategy = strategy;
            updateOrdersSummary(getTodayTrades());
        }

        function updateRecentOrders(todayTrades) {
            if (todayTrades.length === 0) {
                elements.recentOrders.innerHTML = '<div class="no-data">No Data</div>';
                return;
            }
            
            const strategies = new Set();
            const len = todayTrades.length;
            for (let i = 0; i < len; i++) {
                const trade = todayTrades[i];
                if (trade.strategy && trade.strategy !== 'Unknown') {
                    strategies.add(trade.strategy);
                }
            }
            
            const strategyArray = Array.from(strategies).sort();
            
            if (strategyArray.length === 0) {
                elements.recentOrders.innerHTML = '<div class="no-data">No Data</div>';
                return;
            }
            
            if (!selectedRecentStrategy || !strategyArray.includes(selectedRecentStrategy)) {
                selectedRecentStrategy = strategyArray[0];
            }
            
            const htmlParts = ['<div class="strategy-tabs">'];
            for (let i = 0; i < strategyArray.length; i++) {
                const strategy = strategyArray[i];
                htmlParts.push(`<div class="strategy-tab ${strategy === selectedRecentStrategy ? 'active' : ''}" onclick="selectRecentStrategy('${strategy}')">${strategy}</div>`);
            }
            htmlParts.push('</div>');
            
            htmlParts.push('<table class="orders-table"><thead><tr>');
            htmlParts.push('<th>S.No</th><th>Date</th><th>Trade</th><th>Symbol</th>');
            htmlParts.push('<th style="text-align: center;">EN TIME</th><th style="text-align: center;">EX TIME</th>');
            htmlParts.push('<th style="text-align: right;">Qty</th>');
            htmlParts.push('<th style="text-align: right;">Entry Price</th><th style="text-align: right;">Exit Price</th>');
            htmlParts.push('<th style="text-align: right;">Profit</th><th style="text-align: right;">Lot Size</th>');
            htmlParts.push('</tr></thead><tbody>');
            
            const filteredTrades = todayTrades
                .filter(trade => trade.strategy === selectedRecentStrategy)
                .sort((a, b) => (a.symbol || '').toString().toUpperCase().localeCompare((b.symbol || '').toString().toUpperCase()));
            
            if (filteredTrades.length === 0) {
                htmlParts.push('<tr><td colspan="11" style="text-align: center; padding: 20px; color: #cbd5e1;">No trades for this strategy</td></tr>');
            } else {
                for (let i = 0; i < filteredTrades.length; i++) {
                    const trade = filteredTrades[i];
                    const pnl = trade.profit || 0;
                    htmlParts.push(`<tr>
                        <td>${trade.sno || i + 1}</td>
                        <td>${trade.date || '-'}</td>
                        <td>${trade.trade ? trade.trade.toString().toUpperCase() : '-'}</td>
                        <td>${trade.symbol || '-'}</td>
                        <td style="text-align: center;">${trade.a_entime || '-'}</td>
                        <td style="text-align: center;">${trade.a_extime || '-'}</td>
                        <td style="text-align: right;">${trade.qty && trade.qty > 0 ? trade.qty : '-'}</td>
                        <td style="text-align: right;">${trade.entry && trade.entry > 0 ? trade.entry.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${trade.exit && trade.exit > 0 ? trade.exit.toFixed(2) : '-'}</td>
                        <td class="profit-cell ${pnl >= 0 ? 'positive' : 'negative'}">${pnl !== 0 ? `₹${pnl >= 0 ? '' : '-'}${Math.abs(pnl).toLocaleString('en-IN', {maximumFractionDigits: 0})}` : '-'}</td>
                        <td style="text-align: right;">1.0</td>
                    </tr>`);
                }
            }
            
            htmlParts.push('</tbody></table>');
            elements.recentOrders.innerHTML = htmlParts.join('');
        }
        
        function selectRecentStrategy(strategy) {
            selectedRecentStrategy = strategy;
            updateRecentOrders(getTodayTrades());
        }

        function initializeChart() {
            const ctx = elements.pnlChart.getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: [],
                        borderColor: '#059669',
                        backgroundColor: 'transparent',
                        borderWidth: 2.5,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        pointHoverBackgroundColor: '#059669',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#1e293b',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: ctx => `P&L: ₹${ctx.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            display: true,
                            grid: { color: '#f1f5f9', drawBorder: false },
                            ticks: {
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto' },
                                color: '#94a3b8',
                                callback: value => {
                                    if (value === 0) return '₹0';
                                    if (Math.abs(value) >= 100000) return `₹${(value / 100000).toFixed(1)}L`;
                                    return `₹${(value / 1000).toFixed(0)}k`;
                                }
                            }
                        },
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: {
                                font: { size: 11, family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto' },
                                color: '#94a3b8',
                                maxTicksLimit: 8
                            }
                        }
                    },
                    interaction: { intersect: false, mode: 'index' }
                }
            });
        }

        function updateChart() {
            if (!chartInstance) initializeChart();
            
            if (allTrades.length === 0) {
                chartInstance.data.labels = [];
                chartInstance.data.datasets[0].data = [];
                chartInstance.update('none');
                return;
            }
            
            const maxPoints = 100;
            const step = Math.max(1, Math.floor(allTrades.length / maxPoints));
            const sampledTrades = [];
            for (let i = 0; i < allTrades.length; i += step) {
                sampledTrades.push(allTrades[i]);
            }
            
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const labels = new Array(sampledTrades.length);
            const data = new Array(sampledTrades.length);
            
            for (let i = 0; i < sampledTrades.length; i++) {
                const trade = sampledTrades[i];
                if (trade.date) {
                    const [day, month] = trade.date.split('/');
                    labels[i] = `${day.padStart(2, '0')}-${monthNames[parseInt(month) - 1] || ''}`;
                } else {
                    labels[i] = '';
                }
                data[i] = trade.cumPnl;
            }
            
            const minValue = Math.min(...data);
            const maxValue = Math.max(...data);
            const padding = (maxValue - minValue) * 0.05;
            
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = data;
            chartInstance.data.datasets[0].borderColor = data[data.length - 1] >= 0 ? '#059669' : '#dc2626';
            chartInstance.data.datasets[0].pointHoverBackgroundColor = data[data.length - 1] >= 0 ? '#059669' : '#dc2626';
            chartInstance.options.scales.y.min = minValue - padding;
            chartInstance.options.scales.y.max = maxValue + padding;
            chartInstance.update('none');
        }
    </script>
</body>
</html>
